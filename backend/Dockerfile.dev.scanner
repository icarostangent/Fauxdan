FROM ubuntu:22.04

WORKDIR /app

ENV DEBIAN_FRONTEND=noninteractive

# Install system dependencies
RUN apt-get -y update && apt-get -y upgrade && \
    apt-get -y install build-essential libpcap0.8 dnsutils python3-pip \
    python3-dev libpq-dev postgresql-client

# Install masscan
RUN apt-get -y install git && \
    git clone https://github.com/robertdavidgraham/masscan.git &&\
    cd masscan && \
    make && make install

# Install proxychains
RUN git clone https://github.com/haad/proxychains.git &&\
    cd proxychains &&\
    ./configure && make && make install

# Install Python dependencies
COPY requirements.txt ./
RUN pip3 install -r requirements.txt

# Copy application code
COPY . .

# Create necessary directories
RUN mkdir -p /var/log/app /app/masscan

# Create masscan exclude file
RUN echo "127.0.0.0/8" > /app/masscan/exclude.conf && \
    echo "10.0.0.0/8" >> /app/masscan/exclude.conf && \
    echo "172.16.0.0/12" >> /app/masscan/exclude.conf && \
    echo "192.168.0.0/16" >> /app/masscan/exclude.conf

# Set proper permissions
RUN chmod +x /usr/local/bin/masscan

# Default command
CMD ["python3", "manage.py", "run_scanner_service", "--max-concurrent", "2", "--job-types", "masscan"]