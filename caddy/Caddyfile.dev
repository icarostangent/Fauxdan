{
    # Development configuration
    debug
    admin off
    local_certs
    # Allow self-signed certs for development
    skip_install_trust
}

localhost, dev2.icarostangent.lab {
    # Force self-signed certificate
    tls internal

    # Handle analytics requests
    handle /analytics/* {
        reverse_proxy backend:8000
    }

    # Handle API requests
    handle /api/* {
        reverse_proxy backend:8000
    }

    # Handle static files - strip /static prefix and serve from staticfiles
    handle_path /static/* {
        root * /staticfiles
        file_server
    }

    # Handle WebSocket connections for hot reload
    handle /ws {
        reverse_proxy frontend:3000 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
            header_up Connection {>Connection}
            header_up Upgrade {>Upgrade}
        }
    }

    # Handle frontend requests - only for non-API, non-static paths
    handle {
        reverse_proxy frontend:3000 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Structured JSON logging for ELK stack
    log {
        output stdout
        format json
        level INFO
    }
}