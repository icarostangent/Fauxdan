{
    # Development configuration for admin panel
    debug
    admin off
    local_certs
    # Allow self-signed certs for development
    skip_install_trust
}



# HTTPS server for admin panel (port 8443)
localhost:8443 {
    # Force self-signed certificate
    tls internal

    # Route Django admin to backend-admin service
    handle /admin {
        reverse_proxy backend-admin:8000
    }
    
    handle /admin/* {
        reverse_proxy backend-admin:8000
    }

    # Route Grafana to the grafana service
    handle /grafana {
        reverse_proxy grafana:3000
    }
    
    handle /grafana/* {
        reverse_proxy grafana:3000
    }

    # Route Prometheus to the prometheus service
    handle /prometheus {
        uri strip_prefix /prometheus
        reverse_proxy prometheus:9090
    }
    
    handle /prometheus/* {
        uri strip_prefix /prometheus
        reverse_proxy prometheus:9090
    }

    # Route Elasticsearch to the elasticsearch service
    handle /elasticsearch {
        uri strip_prefix /elasticsearch
        reverse_proxy elasticsearch:9200
    }
    
    handle /elasticsearch/* {
        uri strip_prefix /elasticsearch
        reverse_proxy elasticsearch:9200
    }

    # Route Kibana to the kibana service
    handle /kibana {
        reverse_proxy kibana:5601
    }
    
    handle /kibana/* {
        reverse_proxy kibana:5601
    }

    # Route Logstash monitoring to the logstash service
    handle /logstash {
        uri strip_prefix /logstash
        reverse_proxy logstash:9600
    }
    
    handle /logstash/* {
        uri strip_prefix /logstash
        reverse_proxy logstash:9600
    }

    # Handle Prometheus API endpoints (must come before other routes)
    handle /api/v1/* {
        reverse_proxy prometheus:9090
    }
    
    handle /query {
        reverse_proxy prometheus:9090
    }
    
    handle /query/* {
        reverse_proxy prometheus:9090
    }

    # Route metrics endpoints to backend-admin
    handle /metrics {
        reverse_proxy backend-admin:8000
    }
    
    handle /metrics/* {
        reverse_proxy backend-admin:8000
    }

    # Handle static files for Django admin
    handle_path /static/* {
        root * /staticfiles
        file_server
    }

    # Serve admin index page
    handle / {
        root * /admin
        file_server
        try_files {path} /index.html
    }

    # Default route to Django admin for other requests
    handle {
        reverse_proxy backend-admin:8000
    }

    # Detailed development logging
    log {
        output stdout
        format console
        level DEBUG
    }
}
