stages:
  - provision
  - deploy

variables:
  ANSIBLE_HOST_KEY_CHECKING: "False"

provision:
  stage: provision
  script:
    - echo "$SSH_PRIVATE_KEY" > id_rsa.base64
    - echo "$SSH_PRIVATE_KEY" | base64 -d > id_rsa
    - chmod 600 id_rsa
    - ansible all -i hosts.ini --private-key id_rsa -m ping
    - ansible-playbook -K -i hosts.ini --private-key id_rsa provision-server.yml --extra-vars "ansible_become_password=$ansible_become_password"
  only:
    - master

# deploy:staging:
#   stage: deploy
#   environment:
#     name: staging
#     url: https://staging.fauxdan.io
#   script:
#     - echo "$SSH_PRIVATE_KEY" > id_rsa && chmod 600 id_rsa
#     - echo "$ANSIBLE_INVENTORY" > hosts.ini
#     - ansible-playbook -i inventory --private-key id_rsa deploy-application.yml \
#         -e "environment=staging" \
#         -e "git_branch=develop" \
#         -e "gitlab_project=josh/fauxdan" \
#         -e "gitlab_token=$GITLAB_TOKEN"
#   only:
#     - develop
#   when: manual

deploy:production:
  stage: deploy
  environment:
    name: prod
  script:
    - echo "$SSH_PRIVATE_KEY" | base64 -d > id_rsa
    - chmod 600 id_rsa
    - ansible-playbook -i hosts.ini --private-key id_rsa deploy-application.yml -e "environment=prod" -e "git_branch=master" -e "ansible_become_password=$ansible_become_password"
  only:
    - master
  when: manual
  needs:
    - provision
